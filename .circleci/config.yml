version: 2.1

executors:
  java-executor:
    docker:
      - image: circleci/openjdk:11-node-browsers
    working_directory: ~/repo
    environment:
      ANDROID_HOME: /opt/android-sdk
      JAVA_HOME: "/usr/lib/jvm/java-11-openjdk-amd64"
      PATH: "/home/circleci/apache-maven-3.8.4/bin:/opt/android-sdk/cmdline-tools/bin:$PATH"

jobs:
  setup:
    executor: java-executor
    steps:
      - checkout

      - run:
          name: Install curl and other dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y curl unzip

      - restore_cache:
          keys:
            - v1-maven-repo-{{ checksum "pom.xml" }}
            - v1-maven-repo-

      - run:
          name: Install Maven
          command: |
            curl -O https://archive.apache.org/dist/maven/maven-3/3.8.4/binaries/apache-maven-3.8.4-bin.tar.gz
            tar -xzvf apache-maven-3.8.4-bin.tar.gz -C /home/circleci
            echo "export PATH=/home/circleci/apache-maven-3.8.4/bin:$PATH" >> ~/.bashrc
            source ~/.bashrc

      - run:
          name: Install Node.js and npm
          command: |
            curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get update
            sudo apt-get install -y nodejs npm node-gyp
            node -v
            npm -v
            sudo npm install -g npm@latest

      - run:
          name: Install Appium and Android SDK
          command: |
            npm install -g appium
            wget https://dl.google.com/android/repository/commandlinetools-linux-7583922_latest.zip
            unzip commandlinetools-linux-7583922_latest.zip -d /opt/android-sdk
            yes | /opt/android-sdk/cmdline-tools/bin/sdkmanager --licenses
            /opt/android-sdk/cmdline-tools/bin/sdkmanager "platform-tools" "build-tools;30.0.3" "platforms;android-30"
            echo "export PATH=/opt/android-sdk/cmdline-tools/bin:$PATH" >> ~/.bashrc
            echo "export ANDROID_HOME=/opt/android-sdk" >> ~/.bashrc
            source ~/.bashrc

      - save_cache:
          paths:
            - ~/.m2
          key: v1-maven-repo-{{ checksum "pom.xml" }}

      - run:
          name: Verify Android SDK installation
          command: |
            echo $ANDROID_HOME
            ls /opt/android-sdk

  run-tests:
    executor: java-executor
    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-maven-repo-{{ checksum "pom.xml" }}
            - v1-maven-repo-

      - run:
          name: Install dependencies and run Appium tests with Maven
          command: |
            mvn clean install
            mvn test

      - save_cache:
          paths:
            - ~/.m2
          key: v1-maven-repo-{{ checksum "pom.xml" }}

workflows:
  version: 2
  test:
    jobs:
      - setup
      - run-tests:
          requires:
            - setup